#!/bin/bash

FILE_MANAGER="$TERM_FILEMANAGER"
SIZE_PANE=35 # 45 for normal window, tapi jika kecil 30 saja

[ -z "$TMUX" ] && exit

_go_left() {
  tmux select-pane -L
}
_go_right() {
  tmux select-pane -R
}
_go_last_pane() {
  tmux last-pane
}

_check_pane_is_nnn() {
  [ "$(tmux display-message -p "#{pane_id} #{pane_current_command}" | awk '$2 == "nnn" { print $2; exit }')" == "nnn" ]
}
_check_pane_is_lf() {
  [ "$(tmux display-message -p "#{pane_id} #{pane_current_command}" | awk '$2 == "lf" { print $2; exit }')" == "lf" ]
}
_check_pane_is_yazi() {
  [ "$(tmux display-message -p "#{pane_id} #{pane_current_command}" | awk '$2 == "yazi" { print $2; exit }')" == "yazi" ]
}
_check_pane_is_nvim() {
  [ "$(tmux display-message -p "#{pane_id} #{pane_current_command}" | awk '$2 == "nvim" { print $2; exit }')" == "nvim" ]
}
_check_pane_is_zsh() {
  [ "$(tmux display-message -p "#{pane_id} #{pane_current_command}" | awk '$2 == "zsh" { print $2; exit }')" == "zsh" ]
}
_open_file_manager_window() {
  if [[ $1 == "wiki" ]]; then
    WIKI_DIR="$HOME/Dropbox/neorg/"
    if [[ -d "$WIKI_DIR" ]]; then
      tmux split-window -h -l $SIZE_PANE -c "$WIKI_DIR" "$FILE_MANAGER"
    else
      dunstify "wiki $WIKI_DIR not found?"
    fi
  else
    tmux split-window -h -l $SIZE_PANE -c "#{pane_current_path}" "$FILE_MANAGER"
  fi
}

_open_wiki_file_manager_window() {
  _open_file_manager_window "wiki"

}

GET_TOTAL_ACTIVE_PANES=$(tmux display-message -p '#{window_panes}')

clean_tree() {
  if _check_pane_is_nnn; then
    tmux kill-pane
    exit
  fi

  if _check_pane_is_lf; then
    tmux kill-pane
    exit
  fi

  if _check_pane_is_yazi; then
    tmux kill-pane
    exit
  fi

  _go_left

  if _check_pane_is_nnn; then
    tmux kill-pane
    exit
  fi

  if _check_pane_is_nnn; then
    tmux kill-pane
    exit
  fi

  if _check_pane_is_lf; then
    tmux kill-pane
    exit
  fi

  if _check_pane_is_yazi; then
    tmux kill-pane
    exit
  fi

}

open_tree_cwd() {
  if [ "$GET_TOTAL_ACTIVE_PANES" == 1 ]; then
    _open_file_manager_window "fm"
  else
    is_pane_is_right=$(tmux display -p '#{pane_at_right}')
    if [ "$is_pane_is_right" == 0 ]; then
      if _check_pane_is_yazi; then
        clean_tree
      else
        _go_right
        if ! _check_pane_is_yazi; then
          tmux kill-pane
        fi
      fi
    else
      clean_tree
      _go_right
      _open_file_manager_window "fm"
    fi
  fi
}

open_tree_wiki() {
  is_pane_is_right=$(tmux display -p '#{pane_at_right}')
  if ! _check_pane_is_yazi && [[ $is_pane_is_right == "1" ]]; then
    _open_wiki_file_manager_window
  else
    clean_tree
    _go_right
  fi
}

main() {
  if [[ $1 == "wiki" ]]; then
    open_tree_wiki
  else
    open_tree_cwd
  fi

}

main "$@"
